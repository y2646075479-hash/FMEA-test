<!doctype html>
<!-- æœ¬é¡µé¢æ˜¯å‰ç«¯ç•Œé¢å…¥å£ï¼Œç”¨äºå±•ç¤ºå’Œäº¤äº’ FMEA ç”Ÿæˆä¸å‚è€ƒæœç´¢åŠŸèƒ½ -->
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FMEAåŸºç¡€æ•°æ®åº“</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#1f2329;
      --muted:#667085;
      --primary:#1677ff;
      --border:#e5e7eb;
      --chip:#eef4ff;
      --good:#16a34a;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Helvetica Neue",Arial,sans-serif;
    }

    /* é¡µé¢éª¨æ¶ */
    .page{
      padding:12px 16px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .toolbar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background:var(--card); border:1px solid var(--border);
      padding:12px; border-radius:10px;
    }
    .title{font-size:20px; font-weight:700; margin-right:auto}
    .input{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border); border-radius:10px; padding:8px 12px;
      background:#fff; min-width:280px;
    }
    .input input{
      border:none; outline:none; width:240px; font-size:14px;
    }
    .btn{
      border:1px solid var(--border); background:#fff; color:#222;
      padding:9px 12px; border-radius:10px; cursor:pointer;
      transition:.12s ease; user-select:none; font-size:13px;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 2px 10px rgba(0,0,0,.08)}
    .btn.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .btn:disabled{opacity:.6; cursor:not-allowed; transform:none; box-shadow:none}

    /* åŠ è½½æ¡ */
    .loading{
      display:none; margin:10px 0;
      color:#4b5563; font-size:13px;
    }
    .loading.on{display:flex; align-items:center; gap:10px}
    .spinner{width:16px; height:16px; border:2px solid #e5e7eb; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* å¡ç‰‡å®¹å™¨ */
    .card{
      background:var(--card); border:1px solid rgba(15,23,42,.08);
      border-radius:12px; padding:0; overflow:hidden;
      box-shadow:0 18px 40px -24px rgba(15,23,42,.35);
    }
    .card .head{
      padding:12px 14px; border-bottom:1px solid rgba(15,23,42,.08);
      display:flex; align-items:center; gap:8px;
    }
    .card + .card{margin-top:0}
    .card.docs{
      background:linear-gradient(180deg,#fff 0,#f7f9ff 100%);
      padding:16px 0 20px;
    }
    .card.docs .head{gap:12px; font-size:15px}
    .card.docs .body{padding:0 18px 10px}
    .card.docs .divider{
      margin:0 18px 0;
      height:1px; background:rgba(15,23,42,.08);
    }
    .card.docs #docPager{
      padding:0 18px 12px;
    }
    .tag{background:var(--chip); color:#2b59ff; padding:1px 8px; border-radius:20px; font-size:12px}

    /* è¡¨æ ¼åŒºï¼šåªå…è®¸ä¸Šä¸‹æ»šåŠ¨ï¼Œå·¦å³å›ºå®š */
    .table-wrap{
      height:calc(100vh - 260px);
      overflow-y:auto; overflow-x:hidden;
      border-top:1px solid var(--border);
    }
    table{width:100%; border-collapse:collapse}
    thead th{
      position:sticky; top:0; z-index:1;
      background:#fafbff; border-bottom:1px solid var(--border);
      font-weight:700; color:#344054;
      padding:10px 12px; white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px 12px; vertical-align:top;
    }
    tbody tr:hover{background:#fafcff}
    .wrap{white-space:normal; word-break:break-all}
    .num{ text-align:right }

    /* ç›¸å…³èµ„æ–™ Â· åˆ†é¡µï¼ˆä»…æ­¤å¡ç‰‡ï¼‰ */
    #docPager{display:flex;justify-content:space-between;align-items:center;padding:0 10px 12px}
    #docPager .info{color:#98a2b3;font-size:12px}
    #docPager .pager{display:flex;gap:8px}
    #docPager .pager-btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
    #docPager .pager-btn:disabled{opacity:.5;cursor:not-allowed}
    /* === ç›¸å…³èµ„æ–™ Â· SERP åˆ—è¡¨ï¼ˆåŸŸå + æ ‡é¢˜ + æ‘˜è¦ + èƒ¶å›Šå…ƒä¿¡æ¯ï¼‰ === */
    #docsBody.serp-list { display:block; padding:0 10px 12px; }
    .serp-item{ padding:14px 12px; border:1px solid var(--border); border-radius:12px; margin:10px 0; background:#fff; }
    .serp-title{ font-weight:700; font-size:16px; color:#1d4ed8; text-decoration:none; }
    .serp-title:hover{ text-decoration:underline; }
    .serp-desc{ margin-top:6px; font-size:14px; color:#111827; line-height:1.6;
      display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; overflow:hidden; }
    .serp-meta{ margin-top:6px; font-size:12px; color:#64748b; display:flex; gap:8px; flex-wrap:wrap; }
    .serp-meta span{ background:#f3f4f6; border:1px solid var(--border); padding:2px 6px; border-radius:999px; }

    /* favicon è¡Œ */
    .serp-hostline{display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:12px;color:#6b7280}
    .serp-ico{width:16px;height:16px;border-radius:4px;background:#e5e7eb;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 16px}
    .serp-ico img{width:100%;height:100%;object-fit:cover;display:block}
    .serp-ico .fallback{font-size:10px;line-height:1;font-weight:700;color:#111827;display:none}

  </style>
</head>

<body>
  <div class="page">
    <!-- é¡¶éƒ¨å·¥å…·æ¡ -->
    <div class="toolbar">
      <div class="title">FMEAåŸºç¡€æ•°æ®åº“<span id="countNote" class="tag" style="margin-left:8px;">å…± 0 æ¡æ•°æ®</span></div>

      <div class="input">
        <span style="color:#98a2b3">ğŸ”</span>
        <!-- ä¸è®¾ç½®é»˜è®¤å€¼ï¼›placeholder æç¤ºä½†ä¸è‡ªåŠ¨å¡« -->
        <input id="kw" type="text" placeholder="è¯·è¾“å…¥é£ç”µéƒ¨ä»¶ï¼ˆå¦‚ï¼šé½¿è½®ç®±ã€ä¸»è½´ã€å¶ç‰‡â€¦ï¼‰" />
      </div>

      <button id="btnGen" class="btn primary">æœç´¢</button>
      <button id="btnRegen" class="btn">å†ç”Ÿæˆ 10 æ¡</button>
      <button id="btnSort" class="btn">æŒ‰ RPN æ’åº</button>
      <button id="btnCsv"  class="btn">å¯¼å‡º CSV</button>
      <button id="btnPrint" class="btn">æ‰“å°æ ‡å‡†</button>
    </div>

    <!-- æ­£åœ¨ç”Ÿæˆæç¤º -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div id="loadingText">æ­£åœ¨ç”Ÿæˆ FMEA & è”ç½‘èµ„æ–™â€¦</div>
    </div>

    <!-- FMEA è¡¨æ ¼å¡ç‰‡ -->
    <div class="card">
      <div class="head">Sï¼šä¸¥é‡åº¦ (1-10)ã€Oï¼šå‘ç”Ÿåº¦ (1-10)ã€Dï¼šæ¢æµ‹åº¦ (1-10)ï¼ŒRPN = SÃ—OÃ—D</div>
      <div class="table-wrap">
        <table id="fmea">
          <thead>
          <tr>
            <th>åºå·</th>
            <th>é¡¹ç›®</th>
            <th>æ½œåœ¨å¤±æ•ˆæ¨¡å¼</th>
            <th>æ½œåœ¨å¤±æ•ˆåæœ</th>
            <th>S</th>
            <th>æ½œåœ¨å¤±æ•ˆæœºç†</th>
            <th>O</th>
            <th>ç°æœ‰æ§åˆ¶æ–¹æ³•</th>
            <th>ç°æœ‰æ¢æµ‹æ–¹æ³•</th>
            <th>D</th>
            <th>é£é™©åºæ•°</th>
            <th>å»ºè®®æªæ–½</th>
            <th>S_new</th>
            <th>O_new</th>
            <th>D_new</th>
          </tr>
          </thead>
          <tbody>
          <!-- åˆå§‹ä¸ºç©ºï¼›å§‹ç»ˆæ˜¾ç¤ºè¡¨å¤´ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ç›¸å…³èµ„æ–™å¡ç‰‡ï¼šæ”¾åœ¨è¡¨æ ¼â€œä¸‹é¢â€ -->
    <div class="card docs" id="docsCard">
      <div class="head">
        <div>ç›¸å…³èµ„æ–™ <span id="docCount" class="count">(0 æ¡)</span></div>
        <div id="docSource" class="tag" style="margin-left:6px; display:none"></div>
      </div>
      <div class="divider"></div>
      <div class="body" id="docsBody">
        <!-- æ–‡æ¡£å¡ç‰‡æ¸²æŸ“åœ¨æ­¤ï¼›åªæœ‰æ ‡é¢˜é“¾æ¥ï¼Œä¸å†æ˜¾ç¤ºâ€œæ‰“å¼€/å¤åˆ¶â€æŒ‰é’® -->
      </div>
        <!-- åœ¨è¿™é‡Œç²˜è´´ä¸‹é¢è¿™æ®µåˆ†é¡µæ¡ -->
        <div id="docPager">
          <div id="docPagerInfo" class="info">â€”</div>
          <div class="pager">
            <button id="docPrev" class="pager-btn" disabled>ä¸Šä¸€é¡µ</button>
            <button id="docNext" class="pager-btn" disabled>ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

 <script>
  // ---------- åŸºç¡€å·¥å…· ----------
  const $ = sel => document.querySelector(sel);
  const esc = s => String(s ?? '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // å–åµŒå¥—å­—æ®µï¼šæ”¯æŒ "a.b.c"ï¼Œæ”¯æŒæ•°ç»„/å¯¹è±¡ => æ–‡æœ¬åŒ–
  function get(obj, path) {
    if (!obj || !path) return undefined;
    const segs = path.split('.');
    let cur = obj;
    for (const k of segs) {
      if (cur == null) return undefined;
      cur = cur[k];
    }
    // å¦‚æœæ˜¯æ•°ç»„ï¼Œæ‹¼æˆâ€œï¼›â€
    if (Array.isArray(cur)) {
      return cur.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join('ï¼›');
    }
    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œå–å¯è¯»é”®å€¼ï¼ˆé¿å… [object Object]ï¼‰
    if (cur && typeof cur === 'object') {
      // å¸¸è§ç»“æ„ï¼š{ prevention:[...], detection:[...] }
      if (cur.prevention || cur.detection) {
        const p = Array.isArray(cur.prevention) ? cur.prevention.join('ï¼›') : (cur.prevention ?? '');
        const d = Array.isArray(cur.detection) ? cur.detection.join('ï¼›') : (cur.detection ?? '');
        return [p,d].filter(Boolean).join('ï¼›');
      }
      return Object.values(cur).map(v => typeof v === 'string' ? v : JSON.stringify(v)).join('ï¼›');
    }
    return cur;
  }

  // åœ¨å¤šç»„ key/è·¯å¾„ä¸­æ‹©ä¼˜å–æ–‡æœ¬
  function pickText(obj, keys, def = '') {
    for (const k of keys) {
      const v = k.includes('.') ? get(obj, k) : obj?.[k];
      if (v !== undefined && v !== null && String(v).trim() !== '') {
        return String(v);
      }
    }
    return def;
  }

  // ä¸­æ–‡æ•°å­—ï¼ˆã€‡ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åï¼‰â†’ 0..10
  function cn2num(s) {
    const map = {'ã€‡':0,'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸¤':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10};
    if (!s) return NaN;
    // å¤„ç†â€œåâ€â€œåä¸€â€â€œäºŒåâ€â€œäºŒåäº”â€
    if (/å/.test(s)) {
      const [a,b] = s.split('å');
      const tens = a ? map[a] : 1;
      const ones = b ? map[b] : 0;
      return tens*10 + ones;
    }
    let n = 0;
    for (const ch of s) {
      if (map.hasOwnProperty(ch)) n = n*10 + map[ch];
      else return NaN;
    }
    return Number.isFinite(n) ? n : NaN;
  }

  // æ™ºèƒ½æ•°å­—è§£æï¼šä»â€œ6ï¼ˆè¶Šå°è¶Šå¥½ï¼‰/6åˆ†/6/10/â‘¥/ä¸­æ–‡æ•°å­—â€ç­‰æå– 0â€“10
  function pickNumSmart(obj, keys, def = 0) {
    const raw = pickText(obj, keys, '');
    if (raw === '') return def;
    // 1) å…ˆæ‰¾é˜¿æ‹‰ä¼¯æ•°å­—
    const m = String(raw).match(/\d+/);
    if (m) {
      const n = parseInt(m[0], 10);
      return Number.isFinite(n) ? Math.max(0, Math.min(999, n)) : def;
    }
    // 2) å°è¯•ä¸­æ–‡æ•°å­—
    const cn = String(raw).replace(/[^\u4e00-\u9fa5]/g,''); // ä»…ä¸­æ–‡
    const n2 = cn2num(cn);
    if (Number.isFinite(n2)) return Math.max(0, Math.min(999, n2));
    return def;
  }

  // å­—æ®µæ˜ å°„ï¼ˆæ›´å…¨é¢ï¼‰
  const F = {
    project: ['project','é¡¹ç›®','éƒ¨ä»¶','å­ç³»ç»Ÿ','item'],
    failure_mode: ['failure_mode','æ½œåœ¨å¤±æ•ˆæ¨¡å¼','å¤±æ•ˆæ¨¡å¼','å¤±æ•ˆç°è±¡'],
    effects: ['effects','æ½œåœ¨å¤±æ•ˆåæœ','åæœ','å½±å“','å½±å“åæœ'],
    severity: ['severity','ä¸¥é‡åº¦','S','ä¸¥é‡æ€§'],

    mechanism: ['mechanism','æ½œåœ¨å¤±æ•ˆæœºç†','æœºç†','åŸå› ','å¤±æ•ˆåŸå› ','æˆå› ','causes','cause'],

    occurrence: ['occurrence','å‘ç”Ÿåº¦','O','å‘ç”Ÿæ¦‚ç‡','å‡ºç°æ¦‚ç‡','é¢‘åº¦'],

    // ç°æœ‰æ§åˆ¶ï¼šæ”¯æŒå¯¹è±¡/æ•°ç»„
    current_controls: [
      'current_controls','ç°æœ‰æ§åˆ¶æ–¹æ³•','æ§åˆ¶æ–¹æ³•','æ§åˆ¶','ç°æœ‰é¢„é˜²','é¢„é˜²æªæ–½','controls'
    ],

    // æ¢æµ‹æ–¹æ³•ï¼šå¸¸åœ¨ current_controls.detection é‡Œ
    detection_method: [
      'detection_method','ç°æœ‰æ¢æµ‹æ–¹æ³•','æ£€æµ‹æ–¹æ³•','ç›‘æµ‹æ–¹æ³•','æ£€æµ‹æ‰‹æ®µ','æ¢æµ‹æ‰‹æ®µ',
      'ç°æœ‰æ£€æµ‹','æ£€æµ‹','current_controls.detection','controls.detection'
    ],

    detection_score: ['detection_score','æ¢æµ‹åº¦','D','æ£€æµ‹éš¾åº¦'],

    rpn: ['rpn','RPN','é£é™©åºæ•°','é£é™©ä¼˜å…ˆçº§æ•°','é£é™©ä¼˜å…ˆæ•°','é£é™©ä¼˜å…ˆçº§'],

    recommendation: [
      'recommendation','recommendations','å»ºè®®æªæ–½','æ”¹è¿›æªæ–½','æ”¹å–„æªæ–½','æ”¹è¿›å»ºè®®',
      'æ¨èæªæ–½','æªæ–½å»ºè®®','çº æ­£æªæ–½','countermeasures','mitigation','actions','recommended_actions'
    ],

    severity_new: ['severity_new','S_new','ä¸¥é‡åº¦_new','æ–°ä¸¥é‡åº¦'],
    occurrence_new: ['occurrence_new','O_new','å‘ç”Ÿåº¦_new','æ–°å‘ç”Ÿåº¦'],
    detection_new: ['detection_new','D_new','æ¢æµ‹åº¦_new','æ–°æ¢æµ‹åº¦']
  };

  // å½’ä¸€åŒ–ä¸€æ¡è®°å½•ï¼šè¡¥å…¨/çº å
  function normalizeRow(row) {
    const obj = {...row};

    // æ–‡æœ¬ç±»
    obj.project            = pickText(obj, F.project);
    obj.failure_mode       = pickText(obj, F.failure_mode);
    obj.effects            = pickText(obj, F.effects);
    obj.mechanism          = pickText(obj, F.mechanism);

    // æ–¹æ³•ç±»ï¼ˆå¯èƒ½æ¥è‡ªæ•°ç»„/å¯¹è±¡/åµŒå¥—ï¼‰
    // æ§åˆ¶æ–¹æ³•
    const ctrlTxt = pickText(obj, F.current_controls);
    obj.current_controls   = ctrlTxt;

    // æ¢æµ‹æ–¹æ³•ï¼šä¼˜å…ˆå– detection_methodï¼›å¦‚ä¸ºç©ºï¼Œå†ä» current_controls.detection æå–
    let detM = pickText(obj, F.detection_method);
    if (!detM && obj.current_controls) {
      // ä»æ§åˆ¶æ–‡æœ¬é‡Œç®€å•æŠ½å–â€œæ£€æµ‹/æ¢æµ‹/ç›‘æµ‹â€å…³é”®è¯ç‰‡æ®µ
      const m = String(obj.current_controls).match(/((?:æ£€æµ‹|æ¢æµ‹|ç›‘æµ‹)[^ï¼›ã€‚]*)/g);
      if (m && m.length) detM = m.join('ï¼›');
    }
    obj.detection_method = detM;

    // æ•°å€¼ç±»ï¼šæ™ºèƒ½è§£æ
    obj.severity          = pickNumSmart(obj, F.severity, 0);
    obj.occurrence        = pickNumSmart(obj, F.occurrence, 0);
    obj.detection_score   = pickNumSmart(obj, F.detection_score, 0);

    // *_new ç¼ºçœæ—¶å›å¡«æ—§å€¼
    obj.severity_new      = pickNumSmart(obj, F.severity_new, obj.severity);
    obj.occurrence_new    = pickNumSmart(obj, F.occurrence_new, obj.occurrence);
    obj.detection_new     = pickNumSmart(obj, F.detection_new, obj.detection_score);

    // RPNï¼šè‹¥æ— æˆ–ä¸º 0ï¼Œè‡ªåŠ¨è¡¥å…¨
    const rpnRaw          = pickNumSmart(obj, F.rpn, 0);
    obj.rpn               = (rpnRaw && rpnRaw>0)
                              ? rpnRaw
                              : (obj.severity||0) * (obj.occurrence||0) * (obj.detection_score||0);

    // å»ºè®®æªæ–½
    obj.recommendation    = pickText(obj, F.recommendation);

    return obj;
  }

  function normalizeItems(list) {
    if (!Array.isArray(list)) return [];
    return list.map(normalizeRow);
  }

  // ---------- UI ----------
  const btnGen = $('#btnGen');
  const btnRegen = $('#btnRegen');
  const btnSort = $('#btnSort');
  const btnCsv  = $('#btnCsv');
  const btnPrint= $('#btnPrint');
  const inputKw = $('#kw');
  const loading = $('#loading');
  const loadingText = $('#loadingText');
  const countNote = $('#countNote');
  const docsBody  = $('#docsBody');
  const docCount  = $('#docCount');
  const docSource = $('#docSource');

  let tableData = [];
  let sortAsc = false;
  let lastKeyword = '';

  function showLoading(on, text='æ­£åœ¨ç”Ÿæˆ FMEA & è”ç½‘èµ„æ–™â€¦'){
    loading.classList.toggle('on', !!on);
    loadingText.textContent = text;
    btnGen.disabled = !!on;
    if (btnRegen) btnRegen.disabled = !!on;
    inputKw.disabled = !!on;
  }

  function renderTable(items=[]) {
    tableData = Array.isArray(items) ? items : [];
    const tbody = document.querySelector('#fmea tbody');
    tbody.innerHTML = '';

    if (tableData.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="15" style="text-align:center;color:#888;">æœªç”Ÿæˆåˆ° FMEA æ•°æ®</td>`;
      tbody.appendChild(tr);
      countNote.textContent = 'å…± 0 æ¡æ•°æ®';
      return;
    }
    countNote.textContent = `å…± ${tableData.length} æ¡æ•°æ®`;

    tableData.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="wrap">${esc(it.project)}</td>
        <td class="wrap">${esc(it.failure_mode)}</td>
        <td class="wrap">${esc(it.effects)}</td>
        <td class="num">${it.severity}</td>
        <td class="wrap">${esc(it.mechanism)}</td>
        <td class="num">${it.occurrence}</td>
        <td class="wrap">${esc(it.current_controls)}</td>
        <td class="wrap">${esc(it.detection_method)}</td>
        <td class="num">${it.detection_score}</td>
        <td class="num">${it.rpn}</td>
        <td class="wrap">${esc(it.recommendation)}</td>
        <td class="num">${it.severity_new}</td>
        <td class="num">${it.occurrence_new}</td>
        <td class="num">${it.detection_new}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDocs(list=[], source=''){
    docsBody.innerHTML = '';
    docCount.textContent = `(${(Array.isArray(list)?list.length:0)} æ¡)`;
    if(source){ docSource.style.display='inline-block'; docSource.textContent = source; }
    else{ docSource.style.display='none'; }

    if(!Array.isArray(list) || list.length === 0){
      docsBody.innerHTML = `<div style="color:#98a2b3">æ²¡æœ‰åŒ¹é…çš„èµ„æ–™</div>`;
      return;
    }
    list.forEach(it=>{
      const a = document.createElement('a');
      a.href = it.url; a.target="_blank"; a.rel="noopener noreferrer";
      a.textContent = it.title || it.url;

      const card = document.createElement('div');
      card.className = 'doc';
      card.appendChild(a);
      docsBody.appendChild(card);
    });
  }

  function sortByRPN(){
    if(!Array.isArray(tableData) || tableData.length<2) return;
    sortAsc = !sortAsc;
    tableData.sort((a,b)=> (sortAsc ? (a.rpn - b.rpn) : (b.rpn - a.rpn)));
    renderTable(tableData);
  }

  function exportCSV(){
    if(!Array.isArray(tableData) || tableData.length === 0){
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); return;
    }
    const header = ['åºå·','é¡¹ç›®','æ½œåœ¨å¤±æ•ˆæ¨¡å¼','æ½œåœ¨å¤±æ•ˆåæœ','ä¸¥é‡åº¦','æ½œåœ¨å¤±æ•ˆæœºç†','å‘ç”Ÿåº¦','ç°æœ‰æ§åˆ¶æ–¹æ³•','ç°æœ‰æ¢æµ‹æ–¹æ³•','æ¢æµ‹åº¦','é£é™©åºæ•°','å»ºè®®æªæ–½','ä¸¥é‡åº¦_new','å‘ç”Ÿåº¦_new','æ¢æµ‹åº¦_new'];
    const rows = tableData.map((it, i)=>[
      i+1, it.project, it.failure_mode, it.effects, it.severity, it.mechanism,
      it.occurrence, it.current_controls, it.detection_method, it.detection_score,
      it.rpn, it.recommendation, it.severity_new, it.occurrence_new, it.detection_new
    ]);
    const csv = [header, ...rows]
      .map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(','))
      .join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `FMEA_${(inputKw.value||'æœªå‘½å')}.csv`;
    a.click(); URL.revokeObjectURL(url);
  }

  function printStd(){ window.print(); }

  // ---------- æœç´¢ä¸»æµç¨‹ ----------
  async function onSearch(){
    const kw = inputKw.value.trim();
    if(!kw){ alert('è¯·è¾“å…¥è¦åˆ†æçš„é£ç”µéƒ¨ä»¶'); inputKw.focus(); return; }

    showLoading(true);
    try{
      // 1) ç”Ÿæˆ FMEA æ•°æ®
      const r1 = await fetch('http://127.0.0.1:3001/fmea/generate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ part: kw, count: 10 })
      });
      const j1 = await r1.json();
      const items = normalizeItems(j1?.items || []);
      renderTable(items);
      if(items.length){ lastKeyword = kw; }

      // 2) ç›¸å…³èµ„æ–™ï¼ˆæ”¹ç”¨ /api/refsï¼Œæ”¯æŒåˆ†é¡µï¼‰
    await loadRefs(`é£ç”µ${kw} å¤±æ•ˆ æ¨¡å¼`.replace(/\s+/g, ''), 1);
    }catch(err){
      alert('ç”Ÿæˆæˆ–æœç´¢å¤±è´¥ï¼š' + (err?.message || err));
    }finally{
      showLoading(false);
    }
  }

  async function onRegenerate(){
    if(!Array.isArray(tableData) || tableData.length === 0){
      alert('è¯·å…ˆç‚¹å‡»"æœç´¢"ç”Ÿæˆåˆå§‹ FMEA æ•°æ®'); inputKw.focus(); return;
    }
    const kw = lastKeyword || inputKw.value.trim();
    if(!kw){
      alert('å½“å‰é£ç”µéƒ¨ä»¶æœªçŸ¥ï¼Œè¯·é‡æ–°æœç´¢åå†è¯•'); inputKw.focus(); return;
    }

    showLoading(true, 'æ­£åœ¨è¿½åŠ  FMEA æ•°æ®â€¦');
    try{
      const r = await fetch('http://127.0.0.1:3001/fmea/generate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ part: kw, count: 10 })
      });
      const j = await r.json();
      const moreItems = normalizeItems(j?.items || []);
      if(moreItems.length === 0){
        alert('æœªè·å–åˆ°æ–°çš„ FMEA æ•°æ®'); return;
      }
      renderTable([...tableData, ...moreItems]);
    }catch(err){
      alert('è¿½åŠ ç”Ÿæˆå¤±è´¥ï¼š' + (err?.message || err));
    }finally{
      showLoading(false);
    }
  }

  // äº‹ä»¶ç»‘å®š
  btnGen.addEventListener('click', onSearch);
  if(btnRegen) btnRegen.addEventListener('click', onRegenerate);
  $('#kw').addEventListener('keydown', e=>{ if(e.key==='Enter') onSearch(); });
  $('#btnSort').addEventListener('click', sortByRPN);
  $('#btnCsv').addEventListener('click', exportCSV);
  $('#btnPrint').addEventListener('click', printStd);

  // åˆå§‹
  renderDocs([]);
  // === ç›¸å…³èµ„æ–™ Â· è”ç½‘+åˆ†é¡µï¼ˆä¿æŒåŸæœ‰å°å¡ç‰‡æ ·å¼ï¼‰ ===
    const REFS_PAGE_SIZE = 9;      // æ¯é¡µæ¡æ•°ï¼›ä½ çš„ 3 åˆ—ç½‘æ ¼ Ã— 3 è¡Œåˆšå¥½
    let refsState = { q:'', page:1 };

    async function loadRefs(q, page = 1){
      refsState.q = q; refsState.page = page;

      // UIï¼šæ¥æºæ ‡ç­¾ + åˆ†é¡µæç¤º
      docSource.style.display = 'inline-block';
      docSource.textContent = 'serpapi/baidu';
      $('#docPagerInfo').textContent = 'åŠ è½½ä¸­â€¦';
      $('#docPrev').disabled = true; $('#docNext').disabled = true;

      try{
        // å¦‚æœä¸æ˜¯ä» 3001 æ‰“å¼€çš„é¡µé¢ï¼Œå°±æŠŠ API å‘åˆ° 3001
        const API_BASE = (location.protocol === 'file:' || location.port !== '3001')
          ? 'http://127.0.0.1:3001'
          : '';
        const url = `${API_BASE}/api/refs?q=${encodeURIComponent(q)}&engine=baidu&page=${page}&page_size=${REFS_PAGE_SIZE}`;
        const data = await fetch(url).then(r=>r.json());

        const items = Array.isArray(data.items) ? data.items : [];
        renderDocsSerp(items, 'serpapi/baidu');                   // å¤ç”¨ä½ åŸæ¥çš„æ¸²æŸ“ï¼ˆå°å¡ç‰‡æ ·å¼ï¼‰
        $('#docPagerInfo').textContent = `ç¬¬ ${page} é¡µ Â· æœ¬é¡µ ${items.length} æ¡`;

        // åˆ†é¡µæŒ‰é’®
        const prevToken = data.prev_page_token, nextToken = data.next_page_token;
        const bind = (el, enabled, toPage) => {
          el.disabled = !enabled;
          el.onclick = enabled ? () => loadRefs(q, toPage) : null;
        };
        bind($('#docPrev'), !!prevToken, parseInt(prevToken||page-1,10));
        bind($('#docNext'), !!nextToken, parseInt(nextToken||page+1,10));

      }catch(e){
        docsBody.innerHTML = `<div style="color:#e11d48">å‚è€ƒèµ„æ–™åŠ è½½å¤±è´¥ï¼š${esc(e.message||e)}</div>`;
        $('#docPagerInfo').textContent = 'â€”';
      }
    }
    // è¿‡æ»¤æ‰æ— æ•ˆçš„ URLï¼Œé¿å…æ¸²æŸ“å‡ºå ä½é“¾æ¥
    function isValidHttpUrl(s){
      try {
        const u = new URL(s);
        if (!['http:', 'https:'].includes(u.protocol)) return false;
        if (u.hostname.toLowerCase().startsWith('nourl.') && u.hostname.endsWith('.baidu.com')) return false;
        return true;
      } catch { return false; }
    }

    // === ç›¸å…³èµ„æ–™ï¼ˆSERP å±•ç¤ºï¼šåŸŸå + favicon + æ ‡é¢˜ + ä¸¤è¡Œæ‘˜è¦ + å…ƒä¿¡æ¯ï¼‰ ===
    function renderDocsSerp(list, source){
      list = (Array.isArray(list) ? list : []).filter(x => isValidHttpUrl(x.url));
      const el = $('#docsBody');
      el.classList.add('serp-list');   // åˆ‡æ¢ä¸º SERP å®¹å™¨
      const html = (list || []).map(it => {
        const host = esc(it.host || '');
        const title = esc(it.title || it.url || '');
        const url = esc(it.url || '#');
        const ico = esc(it.favicon || '');
        const initial = host ? host[0].toUpperCase() : '?';

        // ä¸¤è¡Œæ‘˜è¦ + å…³é”®è¯é«˜äº®ï¼ˆç”¨ refsState.q é‡Œçš„è¯ï¼‰
        const desc = highlightTerms(it.snippet || '', (window.refsState && refsState.q) || '');
        const date = it.published_at ? `<span>${esc(it.published_at)}</span>` : '';
        const file = it.filetype ? `<span>${esc(String(it.filetype).toUpperCase())}</span>` : '';
        const tag  = it.source_tag ? `<span>${esc(it.source_tag)}</span>` : '';

        return `
          <article class="serp-item">
            <div class="serp-hostline">
              <span class="serp-ico">
                <img src="${ico}" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-block'">
                <span class="fallback">${initial}</span>
              </span>
              ${host}
            </div>
            <a class="serp-title" href="${url}" target="_blank" rel="noopener">${title}</a>
            ${desc ? `<p class="serp-desc">${desc}</p>` : ``}
            <div class="serp-meta">${date}${file}${tag}</div>
          </article>`;
      }).join('');
      el.innerHTML = html || `<div class="serp-item" style="color:#6b7280">ï¼ˆæœªæ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼‰</div>`;
      if (window.docSource){ docSource.style.display='inline-block'; docSource.textContent = source || 'serpapi/baidu'; }
    }

    // å…³é”®è¯é«˜äº®å·¥å…·ï¼ˆè‹¥å·²å­˜åœ¨åŒåå‡½æ•°ï¼Œå¯è·³è¿‡ï¼‰
    function highlightTerms(text, q){
      let out = esc(text || '');
      const terms = String(q || '').split(/\s+/).filter(Boolean).slice(0,6);
      for(const t of terms){
        const re = new RegExp(`(${t.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&')})`,'gi');
        out = out.replace(re,'<mark>$1</mark>');
      }
      return out;
    }
</script>
</body>
</html>
